# 人形語 仕様書
ものすごい勢いで暫定版です。
正確な仕様はソースを参照のこと。

# 字句
正規表現おさらい
* X\* Xが0個以上
* X\+ Xが1個以上
* X\? Xが0個または1個
* [abc] abcのうちどれか1つ
* [a-c] abcのうちどれか1つ

## 行コメント
半角シャープから行末まではコメントです。
```Ruby
#人形語 ハッシュタグが自動で行コメントになります
print("hello")
```

## 識別子
英数字またはアンダースコアを1文字以上。ただし先頭は数字以外。
```
[_a-zA-Z][_a-zA-Z0-9]*
```

## 整数リテラル
10進数しかないし0から始まっても何でもいいです。(てきとう)
```
[0-9]+
```

## 浮動小数点数リテラル
ドットは正規表現の任意の1文字ではなく小数点のドット。
指数なし表記はドットの左右に数字が1文字以上。
指数ありの場合は小数点以下を省略可。
e以下は10のn乗を表します。
```
[0-9]+.[0-9]+
[0-9]+(.[0-9]+)?[eE][+-]?[0-9]+
```
```
0.1
1.0
3e5         # 3 * 10^5
3.14E-12    # 3.14 * 10^-12
```

## 文字列リテラル
ダブルクォーテーション \" で囲みます。
バックスラッシュ \\ で次の1文字をエスケープできます。
ダブルクォーテーションを文字列に入れたい場合に有効です。
```
"white"
"He is a \"white\" person."
```

## 予約語
以下は識別子とは区別されます。
いつの間にか増減しているかもしれません。
* nil
* false
* true
* if
* elif
* else
* while


# 構文

## Program
プログラム全体。
文が0個以上。
* Statement*

## Statement
ステートメント。文。
以下のいずれか。
* If-Statement
* While-Statement
* Expression

## Statement-List
ブレースで0個以上のステートメントを集めたもの。
* "{" Statement* "}"

## If-Statement
if文。
以下の連結。
* "if" "(" Expression ")" Statement-List
* ("elif" "(" Expression ")" Statement-List)*
* ("else" Statement-List)?

## While-Statement
while文。
* "while" "(" Expression ")" Statement-List

## Expression
式。
優先順位と右結合左結合については演算子によって様々です。
* op Expression
    * 単項演算
* Expression op Expression
    * 二項演算
* Expression "(" Expression* ")"
    * 関数呼び出し演算子
* "(" Expression ")"
    * カッコによる優先順位変更
* Value
    * 末端の値

## Value
変数とリテラル。
* "nil"
    * Nil型
* "false"
* "true"
    * Bool型
* ID
    * 変数
* STRING
    * 文字列型
* INT
    * 整数型
* FLOAT
    * 浮動小数点数型
* Array
    * 配列型
* Function
    * 関数型

## Array
配列コンストラクタ。
与えられた値のリストからなる配列を作成して返す。
* "[" ExpressionList "]"

## ExpressionList
要素リストは0個以上のカンマ区切りの式。
* ε
* Expression ("," Expression)*

## Function
関数リテラル。
縦棒内がパラメータ名リスト。
* "|" ParamList "|" Statement-List

## ParamList
パラメータリストは0個以上のカンマ区切りの識別子。
* ε
* ID ("," ID)*

## 演算子
優先順位や結合性はCの演算子リストでも見てください。

### 代入
左辺の変数に代入し、右辺を返す。右結合。
* ID = a

### 関数呼び出し
* a(b, c, d)

### 単項算術
* \+ a
* \- a

### 二項算術
* a + b
* a - b
* a * b
* a / b
* a % b

### 二項比較
* a <= b
* a >= b
* a < b
* a > b
* a == b
* a != b

### 単項論理
* ! a

### 二項論理
* a && b
* a || b


# ランタイム

## 変数
変数は関数のパラメータも含めすべてグローバルです＾＾＾＾＾
ブロックスコープ等はありません＾＾＾＾＾

## 型
* Nil
    * 値は1種類、nilのみ。
    * 存在しない変数を読みだすとこれが返る。
* Bool
    * falseとtrue。
    * ifやwhileなどではBool値が要求されるが、他の型からも自動変換される。nilとfalseがfalse、それ以外はすべてtrue。
* Int
    * C# 32bit signed int
* Float
    * C# 64bit double
* String
    * 文字列。
* Array
    * 配列。
* NativeFunction
    * 組み込み関数。
* UserFunction
    * 関数リテラルによるユーザ定義関数。
    * 組み込み関数と特に扱いに違いはない。

## 配列
配列型の値は配列コンストラクタの構文を使って得ることができます。
他の型の値と同様、変数に代入したり、関数の引数に渡すことができます。
代入によって中身までコピーされることはありません。

配列型の値の後ろに添字演算子\[カッコで囲んだインデックス値\]を適用すると
配列の指定した位置の値を読み出すことができます。
インデックスは0から始まります。
インデックスに用いた値は整数値へ変換が試みられます。不可能ならばランタイムエラー。

配列への書き込みは、まだです。すみません。

```Ruby
a = [1, "white", 3.14, print]
print(a)
a[3](a[0], a[1], a[2])

# 結果
[1,white,3.14,<NFUNC>]
1 white 3.14
```

## 関数
関数型の値は関数リテラルの構文を使うと他の型のリテラルと同じように好きな場所に書くことができます。
他の型の値と同様、変数に代入したり、関数の引数に渡すことができます。

関数型の値の後ろに関数呼び出し演算子(カッコで囲んだ引数リスト)を適用すると関数を呼び出せます。
組み込みまたはユーザ定義関数型でなかった場合はランタイムエラーになります。
返り値は最後に実行したステートメントの値です。
if文などは常にnilを返しますので注意してください。
仮引数に見えるもの |x y| も全部グローバル変数なので注意してください＾＾＾＾＾

```Ruby
f = |x, y| {
    print(x, y)
    x + y
}
print(f(2, 3))

# 結果
2 3
5
```

# 組み込み関数
最初からグローバル変数に代入されている関数値です。

## print, p
引数を順番にスペース区切りで出力し、改行します。
pは文字数節約のための同じ関数です。
* 引数
    * 任意の型, 任意個
* 返り値
    * nil

```Ruby
print("hello", 3.14, "white", print)

hello 3.14 white <NFUNC>
```

## for
初期値から1ずつカウントを増やしながら終了値まで毎回関数を呼び出します。
関数の呼び出し時には第1引数にカウント値が渡されます。
* 引数
    * Int 初期値
    * Int 終了値
    * Function 繰り返しごとに呼び出される関数
        * Int 現在の値
* 返り値
    * nil

```Ruby
for (1, 5, |i| { print(i) })

# iに1から5が渡されて関数が呼び出される
1
2
3
4
5
```
